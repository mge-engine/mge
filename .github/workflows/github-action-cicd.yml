name: MGE CI/CD Build 
run-name: Build ${{ github.run_id }} - ${{ github.run_number }}
on:
  push:
    branches-ignore:
      - gh-pages
  pull_request:

jobs:
# -- macos latest runner
    build-macos-latest:
      if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.repository
      name : Build x64-macos-clang
      runs-on: macos-latest
      env: 
          VCPKG_BINARY_SOURCES: "clear;default,readwrite;files,${{ github.workspace }}/vcpkg_binary_cache,readwrite"
      steps:
          - name: Show Architecture
            run: |
              sysctl -n machdep.cpu.brand_string
          - name: Show OS Version
            run: |
              sw_vers
          - name: Show Python version
            run: |
              python3 --version  
          - name: Install CMake
            run: |
              cmake --version
          - name: Install Automake and related tools
            run: |
              brew install automake autoconf autoconf-archive libtool
          - name: Install Ninja
            run: |
              ninja --version
          - name: Setup ccache
            uses: hendrikmuhs/ccache-action@v1.2
            with:
              key: ${{ runner.os }}-ccache
              max-size: 2G
          - name: Checkout source code
            uses: actions/checkout@v4
            with:
              clean: false
          - name: Cache vcpkg
            id: cache-vcpkg
            uses: actions/cache@v4
            with:
              path: ${{ github.workspace }}/vcpkg
              key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json') }}
              restore-keys: |
                vcpkg-${{ runner.os }}-
          - name: Cache vcpkg binary cache
            id: cache-vcpkg-binary
            uses: actions/cache@v4
            with:
              path: ${{ github.workspace }}/vcpkg_binary_cache
              key: vcpkg-binary-cache-${{ runner.os }}-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json') }}
              restore-keys: |
                vcpkg-binary-cache-${{ runner.os }}-
          - name: Check whether vcpkg exists
            id: check-vcpkg
            run: |
              if [ -f "${{ github.workspace }}/vcpkg/vcpkg" ]; then
                echo "vcpkg exists"
                echo "vcpkg_found=true" >> $GITHUB_OUTPUT
              else
                echo "vcpkg does not exist, need to build"
                echo "vcpkg_found=false" >> $GITHUB_OUTPUT
              fi
          - name: Create vcpkg cache directory
            run: |
                mkdir -p "${{ github.workspace }}/vcpkg_binary_cache"
          - name: Checkout vcpkg
            if: steps.check-vcpkg.outputs.vcpkg_found == 'false'
            uses: actions/checkout@v4
            with:
              repository: mge-engine/vcpkg
              path: ${{ github.workspace }}/vcpkg
              clean: false
          - name: Update vcpkg
            if: steps.check-vcpkg.outputs.vcpkg_found == 'true'
            working-directory: ${{ github.workspace }}/vcpkg
            run: |
              git pull origin master
          - name: Export GitHub Actions cache environment variables
            uses: actions/github-script@v7
            with:
              script: |
                  core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
                  core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');    
          - name: Configure project
            run: |
              export VCPKG_ROOT=${{ github.workspace }}/vcpkg
              export VCPKG_BINARY_SOURCES="clear;x-gha,readwrite;files,${{ github.workspace }}/vcpkg_binary_cache,readwrite"
              export CMAKE_C_COMPILER_LAUNCHER=ccache
              export CMAKE_CXX_COMPILER_LAUNCHER=ccache
              max_attempts=3
              attempt=0
              success=false

              while [ $success = false ] && [ $attempt -lt $max_attempts ]; do
                attempt=$((attempt + 1))
                echo "CMake configure attempt $attempt of $max_attempts"

                if cmake --preset=ci-build; then
                  success=true
                  echo "CMake configuration succeeded on attempt $attempt"
                else
                  if [ $attempt -eq $max_attempts ]; then
                    echo "CMake configuration failed after $max_attempts attempts"
                    exit 1
                  fi
                  echo "CMake configuration failed on attempt $attempt. Retrying..."
                  sleep 5
                fi
              done
          - name: Build project
            run: |
              export VCPKG_ROOT=${{ github.workspace }}/vcpkg
              cmake --build build --parallel 4 --target all
          - name: Run Tests
            working-directory: ${{ github.workspace }}/build
            run: |
              export VCPKG_ROOT=${{ github.workspace }}/vcpkg
              ctest --verbose
          - name: Upload test results
            uses: actions/upload-artifact@v4
            with:
              name: test-results-macos-latest
              path: ${{ github.workspace }}/build/test_*.xml
          - name: Publish Test Results
            uses: mikepenz/action-junit-report@v3
            with:
              report_paths: '${{ github.workspace }}/build/test_*.xml'
#  -- linux ubuntu latest runner
    build-linux-ubuntu-latest:
      if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.repository
      name : Build x64-linux-gcc
      runs-on: ubuntu-latest
      env: 
          VCPKG_BINARY_SOURCES: "clear;default,readwrite;files,${{ github.workspace }}/vcpkg_binary_cache,readwrite"
      steps:
          - name: Show Architecture
            run: |
              lscpu
          - name: Show OS Version
            run: |
              cat /etc/os-release
          - name: Update and upgrade apt packages
            run: |
              sudo apt-get update
              sudo apt-get upgrade -y
          - name: Show Python version
            run: |
              python3 --version  
          - name: Install CMake
            run: |
              sudo snap install cmake --classic
              cmake --version
          - name: Install Ninja
            run: |
              sudo apt-get install -y ninja-build
          - name: Install automake and autoconf
            run: |
              sudo apt-get install -y automake autoconf autoconf-archive libtool
          - name: Setup ccache
            uses: hendrikmuhs/ccache-action@v1.2
            with:
              key: ${{ runner.os }}-ccache
              max-size: 2G
          - name: Checkout source code
            uses: actions/checkout@v4
            with:
              clean: false
          - name: Cache vcpkg
            id: cache-vcpkg
            uses: actions/cache@v4
            with:
              path: ${{ github.workspace }}/vcpkg
              key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json') }}
              restore-keys: |
                vcpkg-${{ runner.os }}-
          - name: Cache vcpkg binary cache
            id: cache-vcpkg-binary
            uses: actions/cache@v4
            with:
              path: ${{ github.workspace }}/vcpkg_binary_cache
              key: vcpkg-binary-cache-${{ runner.os }}-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json') }}
              restore-keys: |
                vcpkg-binary-cache-${{ runner.os }}-
          - name: Check whether vcpkg exists
            id: check-vcpkg
            run: |
              if [ -f "${{ github.workspace }}/vcpkg/vcpkg" ]; then
                echo "vcpkg exists"
                echo "vcpkg_found=true" >> $GITHUB_OUTPUT
              else
                echo "vcpkg does not exist, need to build"
                echo "vcpkg_found=false" >> $GITHUB_OUTPUT
              fi
          - name: Create vcpkg cache directory
            run: |
                mkdir -p "${{ github.workspace }}/vcpkg_binary_cache"
          - name: Checkout vcpkg
            if: steps.check-vcpkg.outputs.vcpkg_found == 'false'
            uses: actions/checkout@v4
            with:
              repository: mge-engine/vcpkg
              path: ${{ github.workspace }}/vcpkg
              clean: false
          - name: Update vcpkg
            if: steps.check-vcpkg.outputs.vcpkg_found == 'true'
            working-directory: ${{ github.workspace }}/vcpkg
            run: |
              git pull origin master
          - name: Export GitHub Actions cache environment variables
            uses: actions/github-script@v7
            with:
              script: |
                  core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
                  core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');    
          - name: Setup compilers
            run: |
              sudo apt-get install -y gcc-14 g++-14
          - name: Configure project
            run: |
              export CC=gcc-14
              export CXX=g++-14
              export VCPKG_ROOT=${{ github.workspace }}/vcpkg
              export VCPKG_BINARY_SOURCES="clear;x-gha,readwrite;files,${{ github.workspace }}/vcpkg_binary_cache,readwrite"
              export CMAKE_C_COMPILER_LAUNCHER=ccache
              export CMAKE_CXX_COMPILER_LAUNCHER=ccache
              max_attempts=3
              attempt=0
              success=false

              while [ $success = false ] && [ $attempt -lt $max_attempts ]; do
                attempt=$((attempt + 1))
                echo "CMake configure attempt $attempt of $max_attempts"

                if cmake --preset=ci-build; then
                  success=true
                  echo "CMake configuration succeeded on attempt $attempt"
                else
                  if [ $attempt -eq $max_attempts ]; then
                    echo "CMake configuration failed after $max_attempts attempts"
                    exit 1
                  fi
                  echo "CMake configuration failed on attempt $attempt. Retrying..."
                  sleep 5
                fi
              done
          - name: Build project
            run: |
              export CC=gcc-14
              export CXX=g++-14
              export VCPKG_ROOT=${{ github.workspace }}/vcpkg
              cmake --build build --parallel 8 --target all
          - name: Run Tests
            working-directory: ${{ github.workspace }}/build
            run: |
              export CC=gcc-14
              export CXX=g++-14
              export VCPKG_ROOT=${{ github.workspace }}/vcpkg
              ctest --verbose
          - name: Upload test results
            uses: actions/upload-artifact@v4
            with:
              name: test-results-ubuntu-latest
              path: ${{ github.workspace }}/build/test_*.xml
          - name: Publish Test Results
            uses: mikepenz/action-junit-report@v3
            with:
              report_paths: '${{ github.workspace }}/build/test_*.xml'
# -- windows latest runner - msvc
    build-msvc-windows-latest:
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.repository
        name: Build x64-windows-msvc
        runs-on: windows-latest
        env: 
            VCPKG_BINARY_SOURCES: "clear;default,readwrite;files,${{ github.workspace }}\\vcpkg_binary_cache,readwrite"
        steps:
            - name: Show Architecture
              run: |
                Get-CimInstance Win32_Processor | Select-Object Name, Manufacturer, NumberOfCores, NumberOfLogicalProcessors
            - name: Show Python version
              run: |
                python --version
            - name: Install CMake
              run: |
                choco install cmake
                cmake --version
            - name: Install Ninja
              run: |
                choco install ninja
            - name: Checkout source code
              uses: actions/checkout@v4
              with:
                clean: false
            - name: Cache vcpkg
              id: cache-vcpkg
              uses: actions/cache@v4
              with:
                path: ${{ github.workspace }}/vcpkg
                key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json') }}
                restore-keys: |
                  vcpkg-${{ runner.os }}-
            - name: Cache vcpkg binary cache
              id: cache-vcpkg-binary
              uses: actions/cache@v4
              with:
                path: ${{ github.workspace }}/vcpkg_binary_cache
                key: vcpkg-binary-cache-${{ runner.os }}-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json') }}
                restore-keys: |
                  vcpkg-binary-cache-${{ runner.os }}-
            - name: Check whether vcpkg exists
              id: check-vcpkg
              run: |
                if (Test-Path "${{ github.workspace }}/vcpkg/vcpkg.exe") {
                  Write-Output "vcpkg exists"
                  Write-Output "vcpkg_found=true" >> $env:GITHUB_OUTPUT
                } else {
                  Write-Output "vcpkg does not exist, need to build"
                  Write-Output "vcpkg_found=false" >> $env:GITHUB_OUTPUT
                }
            - name: Create vcpkg cache directory
              run: |
                if (!(Test-Path "${{ github.workspace }}/vcpkg_binary_cache")) {
                  New-Item -Path "${{ github.workspace }}/vcpkg_binary_cache" -ItemType Directory
                }
            - name: Checkout vcpkg
              if: steps.check-vcpkg.outputs.vcpkg_found == 'false'
              uses: actions/checkout@v4
              with:
                repository: mge-engine/vcpkg
                path: ${{ github.workspace }}/vcpkg
                clean: false
            - name: Update vcpkg
              if: steps.check-vcpkg.outputs.vcpkg_found == 'true'
              working-directory: ${{ github.workspace }}/vcpkg
              run: |
                git pull origin master
            - name: Export GitHub Actions cache environment variables
              uses: actions/github-script@v7
              with:
                script: |
                    core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
                    core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');                
            - name: Setup Vulkan
              run: |
                python tools/ci/vulkan.py
            - name: Setup Microsoft Visual C++ 
              uses: ilammy/msvc-dev-cmd@v1           
            - name: Configure project
              run: |
                $env:CC = "cl.exe"
                $env:CXX = "cl.exe"
                $env:VCPKG_VERBOSE="1" 
                $env:VULKAN_SDK = "C:\VulkanSDK\1.4.309.0"
                $env:VCPKG_ROOT = "${{ github.workspace }}\vcpkg"
                $maxAttempts = 3
                $attempt = 0
                $success = $false
                
                while (-not $success -and $attempt -lt $maxAttempts) {
                  $attempt++
                  Write-Output "CMake configure attempt $attempt of $maxAttempts"
                  
                  try {
                  cmake --preset=ci-build
                  $success = $true
                  Write-Output "CMake configuration succeeded on attempt $attempt"
                  } catch {
                  if ($attempt -eq $maxAttempts) {
                    Write-Output "CMake configuration failed after $maxAttempts attempts"
                    throw
                  }
                  Write-Output "CMake configuration failed on attempt $attempt. Retrying..."
                  Start-Sleep -Seconds 5
                  }
                }
            - name: Build project
              run: |
                $env:CC = "cl.exe"
                $env:CXX = "cl.exe"
                $env:VULKAN_SDK = "C:\VulkanSDK\1.4.309.0"
                $env:VCPKG_ROOT = "${{ github.workspace }}\vcpkg"
                cmake --build build --parallel 8 --target all
            - name: Run Tests
              working-directory: ${{ github.workspace }}/build
              run: |
                $env:CC = "cl.exe"
                $env:CXX = "cl.exe"
                $env:VULKAN_SDK = "C:\VulkanSDK\1.4.309.0"
                $env:VCPKG_ROOT = "${{ github.workspace }}\vcpkg"
                ctest --verbose
            - name: Upload test results
              uses: actions/upload-artifact@v4
              with:
                name: test-results-windows-latest
                path: ${{ github.workspace }}/build/test_*.xml
            - name: Publish Test Results
              uses: mikepenz/action-junit-report@v3
              with:
                report_paths: '${{ github.workspace }}/build/test_*.xml'
    build-documentation-windows-latest:
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.repository
        name: Build documentation
        runs-on: windows-latest
        env: 
            VCPKG_BINARY_SOURCES: "clear;default,readwrite;files,${{ github.workspace }}\\vcpkg_binary_cache,readwrite"
        steps:
            - name: Install CMake
              run: |
                choco install cmake 
            - name: Install Ninja
              run: |
                choco install ninja
            - name: Install doxygen.install
              run: |
                choco install doxygen.install
            - name: Checkout source code
              uses: actions/checkout@v4
              with:
                clean: false
            - name: Install Sphinx
              run: |
                python tools/ci/sphinx.py
            - name: Cache vcpkg
              id: cache-vcpkg
              uses: actions/cache@v4
              with:
                path: ${{ github.workspace }}/vcpkg
                key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json') }}
                restore-keys: |
                  vcpkg-${{ runner.os }}-
            - name: Cache vcpkg binary cache
              id: cache-vcpkg-binary
              uses: actions/cache@v4
              with:
                path: ${{ github.workspace }}/vcpkg_binary_cache
                key: vcpkg-binary-cache-${{ runner.os }}-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json') }}
                restore-keys: |
                  vcpkg-binary-cache-${{ runner.os }}-
            - name: Check whether vcpkg exists
              id: check-vcpkg
              run: |
                if (Test-Path "${{ github.workspace }}/vcpkg/vcpkg.exe") {
                  Write-Output "vcpkg exists"
                  Write-Output "vcpkg_found=true" >> $env:GITHUB_OUTPUT
                } else {
                  Write-Output "vcpkg does not exist, need to build"
                  Write-Output "vcpkg_found=false" >> $env:GITHUB_OUTPUT
                }
            - name: Create vcpkg cache directory
              run: |
                if (!(Test-Path "${{ github.workspace }}/vcpkg_binary_cache")) {
                  New-Item -Path "${{ github.workspace }}/vcpkg_binary_cache" -ItemType Directory
                }
            - name: Checkout vcpkg
              if: steps.check-vcpkg.outputs.vcpkg_found == 'false'
              uses: actions/checkout@v4
              with:
                repository: mge-engine/vcpkg
                path: ${{ github.workspace }}/vcpkg
                clean: false
            - name: Update vcpkg
              if: steps.check-vcpkg.outputs.vcpkg_found == 'true'
              working-directory: ${{ github.workspace }}/vcpkg
              run: |
                git pull origin master
            - name: Export GitHub Actions cache environment variables
              uses: actions/github-script@v7
              with:
                script: |
                    core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
                    core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');                
            - name: Setup Microsoft Visual C++ 
              uses: ilammy/msvc-dev-cmd@v1           
            - name: Configure project
              run: |
                $env:CC = "cl.exe"
                $env:CXX = "cl.exe"
                $env:VIRTUAL_ENV = "${{ github.workspace }}\sphinx"      
                $env:PATH = "$env:VIRTUAL_ENV/Scripts;" + $env:PATH
                $env:VCPKG_ROOT = "${{ github.workspace }}\vcpkg"
                cmake --preset=ci-build 
            - name: Build documentation
              run: |
                $env:CC = "cl.exe"
                $env:CXX = "cl.exe"
                $env:VCPKG_ROOT = "${{ github.workspace }}\vcpkg"
                cmake --build build --target documentation
            - name: Checkout gh-pages
              uses: actions/checkout@v4
              with:
                ref: gh-pages
                path: ./build/gh-pages
                clean: false
            - name: Copy documentation for deployment
              run: |
                $env:VIRTUAL_ENV = "${{ github.workspace }}\sphinx"      
                $env:PATH = "$env:VIRTUAL_ENV/Scripts;" + $env:PATH
                git config --global core.autocrlf true
                git config --global user.email "schroeder.alexander@googlemail.com"
                git config --global user.name "Alexander Schroeder"
                $env:CURRENT_BRANCH = "${env:GITHUB_REF}".Replace('refs/heads/', '')
                $env:CURRENT_EVENT = "${{ github.event_name }}"
                echo "Branch: $env:CURRENT_BRANCH"
                echo "Event: $env:CURRENT_EVENT"
                python tools/ci/commit-gh-pages.py
            - name: Push to gh-pages
              uses: ad-m/github-push-action@v0.8.0
              with:
                branch: gh-pages
                directory: ./build/gh-pages
                github_token: ${{ secrets.GITHUB_TOKEN }}
            
